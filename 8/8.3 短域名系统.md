## 8.3 短域名系统

### 应用场景
微博和Twitter都有140字数的限制，如果分享一个长网址，很容易就超出限制。短网址服务可以把一个长网址变成短网址，方便在社交网络上传播。

### 需求分析
在讨论具体的实现之前，我们首先看一下该系统的具体需求。

#### 短网址的长度
当前互联网上的网页总数大概是	45亿（参考http://www.worldwidewebsize.com）：
* 如果使用字符串（Base62）表示，6位字符串应该足以表达全部的网页地址，考虑到一对多的需求，这里考虑使用7位字符串（事实上微博的短域名系统就是7位字符串）
* 如果使用整数表示，一个64位整数足以表达

#### 一对一还是一对多映射
一个长网址对应一个短网址，还是可以对应多个短网址？

一般而言，一个长网址，在不同的地点，不同的用户等情况下，生成的短网址应该不一样。这样在后端数据库中，可以更好的进行数据分析。以这个7位长度的短网址作为唯一ID，这个ID下可以附加上各种应用信息：比如生成该网址的用户名，所在网站等。

### 实现
接下来我们看一下如何实现该短域名系统。

#### 如何计算短网址
现在我们设定了短网址是一个长度为7的字符串，如何计算得到这个短网址呢？最容易想到的办法是使用Hash算法，但是Hash算法会有冲突，如何处理冲突呢，又是一个麻烦。

正确答案：分布式发号器(Distributed	ID	Generator)

#### 如何存储
生成了对应的短域名后，如果存储短域名和长域名的对应关系？以短网址为primary	key，长网址为value，可以用传统的关系数据库存起来，也可以用任意一个分布式KV数据库，例如Redis，LevelDB。

#### 重定向
当访问短域名时，应该使用301还是302呢，这也是一个有意思的问题。这个问题主要是考察对301和302的理解，以及浏览器缓存机制的理解。

301是永久重定向，302是临时重定向。短地址一经生成就不会变化，所以用301是符合http语义的。但是如果用了301，使用搜索引擎搜索的时候会直接展示真实地址，那我们就无法统计到短地址被点击的次数了，也无法收集用户信息，来做数据分析了。所以一般短域名系统是使用302重定向的（微博使用的就是302）。
